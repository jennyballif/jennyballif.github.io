<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Gallery</title>
    <style>
        /* --- CSS STYLES --- */
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --accent: #bb86fc;
            --gap: 20px;
        }

        body {
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        h1 {
            text-align: center;
            font-weight: 300;
            margin-bottom: 40px;
        }

        /* Grid Layout */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--gap);
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Card Styles */
        .card {
            background-color: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.5);
        }

        .card-img-container {
            width: 100%;
            height: 200px; /* Fixed height for thumbnail consistency */
            background-color: #000;
            overflow: hidden;
            position: relative;
        }

        .card-img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Crops to fill */
            display: block;
            opacity: 0; /* Hidden until loaded */
            transition: opacity 0.3s;
        }

        .card-content {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0 0 5px 0;
            color: var(--text-main);
        }

        .card-student {
            font-size: 0.9rem;
            color: var(--accent);
            margin-bottom: 10px;
            font-weight: 500;
        }

        .card-desc {
            font-size: 0.85rem;
            color: var(--text-muted);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 3; /* Limit to 3 lines */
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Loading & States */
        .loading, .error-msg {
            text-align: center;
            width: 100%;
            margin-top: 50px;
            font-size: 1.2rem;
            color: var(--text-muted);
        }

        /* Load More Button */
        .load-more-container {
            text-align: center;
            margin: 40px 0;
            display: none; /* Hidden by default */
        }

        .btn-load {
            background-color: var(--accent);
            color: #000;
            border: none;
            padding: 10px 30px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            transition: opacity 0.2s;
        }

        .btn-load:hover {
            opacity: 0.9;
        }

        /* Modal / Lightbox */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
            background: var(--card-bg);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            position: relative;
        }

        /* Close button */
        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            color: white;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10;
            text-shadow: 0 0 5px black;
        }

        .modal-img-container {
            background: #000;
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            overflow: hidden;
        }

        .modal-img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
        }

        .modal-details {
            padding: 20px;
            background: var(--card-bg);
            border-top: 1px solid #333;
        }

        .modal-title { font-size: 1.4rem; margin: 0 0 5px 0; }
        .modal-student { color: var(--accent); font-size: 1.1rem; margin-bottom: 10px; }
        .modal-desc { color: var(--text-muted); line-height: 1.5; }

        @media (max-width: 600px) {
            .gallery-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <h1 id="gallery-title">Student Gallery</h1>
    
    <div id="app" class="gallery-grid">
        <div class="loading">Loading artwork...</div>
    </div>

    <div class="load-more-container" id="load-more-container">
        <button class="btn-load" onclick="renderBatch()">Load More</button>
    </div>

    <!-- Modal Structure -->
    <div class="modal-overlay" id="modal" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-close" onclick="closeModal()">Ã—</div>
            <div class="modal-img-container">
                <img src="" alt="" class="modal-img" id="modal-img">
            </div>
            <div class="modal-details">
                <h2 class="modal-title" id="modal-title"></h2>
                <div class="modal-student" id="modal-student"></div>
                <div class="modal-desc" id="modal-desc"></div>
            </div>
        </div>
    </div>

    <script>
        /* --- CONFIGURATION --- */
        
        // 1. Your Google Apps Script Web App URL
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwplBtUVpPjJPw_gG_O79LSLAO25sUszwOadP-w3H1yYrXaKDbhhP4T9xeauI0_jJSo/exec';//app script on sheet

        // 2. Your Cloudflare Worker URL
        const IMAGE_PROXY_URL = 'https://student-art-proxy.serge-2da.workers.dev/';//cloudflare under business email

        // 3. Settings
        const BATCH_SIZE = 24; // How many images to show per "page"

        /* --- STATE MANAGEMENT --- */
        let allItems = [];
        let currentIndex = 0;


        /* --- INITIALIZATION --- */
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            let sheetName = params.get('sheet');

            if (!sheetName) {
                document.getElementById('app').innerHTML = '<div class="error-msg">No sheet specified in URL.<br>Use ?sheet=Name_Of_Tab</div>';
                return;
            }

            // --- THE FIX: CLEANER URLS ---
            // Convert underscores back to spaces automatically.
            // URL input: ?sheet=Chemistry_Elemental_Cards
            // Becomes: "Chemistry Elemental Cards"
            sheetName = sheetName.replace(/_/g, ' ');

            // Set the visual title immediately so the user sees "Chemistry Elemental Cards"
            document.getElementById('gallery-title').textContent = sheetName;

            fetchData(sheetName);
        });

        /* --- DATA FETCHING (JSONP) --- */
        function fetchData(sheetName) {
            // Encode the sheet name for URL
            const encodedSheet = encodeURIComponent(sheetName);
            
            // Create the callback function globally so Apps Script can find it
            window.renderGallery = function(response) {
                if (!response || !response.items || response.items.length === 0) {
                    document.getElementById('app').innerHTML = '<div class="error-msg">No submissions found for this assignment.</div>';
                    return;
                }

                // Update Page Title
                if(response.sheet) document.getElementById('gallery-title').textContent = response.sheet;

                // Store data and start rendering
                allItems = response.items.reverse();
                document.getElementById('app').innerHTML = ''; // Clear loading message
                renderBatch();
            };

            // Create script tag for JSONP
            const script = document.createElement('script');
            script.src = `${APPS_SCRIPT_URL}?sheet=${encodedSheet}&callback=renderGallery`;
            script.onerror = () => {
                document.getElementById('app').innerHTML = '<div class="error-msg">Failed to load data. Check connection or sheet name.</div>';
            };
            document.body.appendChild(script);
        }

        /* --- RENDERING --- */
        function renderBatch() {
            const container = document.getElementById('app');
            const nextIndex = Math.min(currentIndex + BATCH_SIZE, allItems.length);
            const batch = allItems.slice(currentIndex, nextIndex);

            batch.forEach(item => {
                const card = createCard(item);
                container.appendChild(card);
            });

            currentIndex = nextIndex;

            // Toggle Load More Button
            const loadMoreContainer = document.getElementById('load-more-container');
            if (currentIndex < allItems.length) {
                loadMoreContainer.style.display = 'block';
            } else {
                loadMoreContainer.style.display = 'none';
            }
        }

        function createCard(item) {
            const fileId = extractFileId(item.imageUrl);
            // Use Proxy URL to avoid ORB
            const safeImageUrl = fileId ? `${IMAGE_PROXY_URL}?id=${fileId}` : '';

            const col = document.createElement('div');
            col.className = 'card';
            col.onclick = () => openModal(item, safeImageUrl);

            col.innerHTML = `
                <div class="card-img-container">
                    <img src="${safeImageUrl}" class="card-img" alt="${item.title}" onload="this.style.opacity=1" loading="lazy">
                </div>
                <div class="card-content">
                    <h3 class="card-title">${escapeHtml(item.title)}</h3>
                    <div class="card-student">By ${escapeHtml(item.studentName)}</div>
                    <div class="card-desc">${escapeHtml(item.description || '')}</div>
                </div>
            `;
            return col;
        }

        /* --- UTILITIES --- */
        // Helper to pull ID from raw Drive URL
        function extractFileId(url) {
            if (!url) return null;
            const match = url.match(/id=([a-zA-Z0-9_-]+)/);
            return match ? match[1] : null;
        }

        // Basic XSS prevention
        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        /* --- MODAL LOGIC --- */
        const modal = document.getElementById('modal');
        const modalImg = document.getElementById('modal-img');
        const modalTitle = document.getElementById('modal-title');
        const modalStudent = document.getElementById('modal-student');
        const modalDesc = document.getElementById('modal-desc');

        function openModal(item, imageUrl) {
            modalImg.src = imageUrl;
            modalTitle.textContent = item.title;
            modalStudent.textContent = `By ${item.studentName}`;
            modalDesc.textContent = item.description || '';
            
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closeModal(event) {
            // Only close if clicking overlay or X, not if clicking content
            if (event && event.target !== modal && !event.target.classList.contains('modal-close')) return;
            
            modal.style.display = 'none';
            modalImg.src = ''; // Clear image to stop memory usage
            document.body.style.overflow = ''; // Restore scrolling
        }
        
        // Close on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal.style.display === 'flex') {
                closeModal();
            }
        });
    </script>
</body>
</html>